# 数据库原理Project2报告
### 基本信息
- 课程：CS307数据库原理
- 学期：23秋
- 理论课教师：程然
- 实验课教师：王维语
- 实验课时间：星期二1-2节

|成员|学号|百分比|贡献内容|
|-|-|-|-|
|何林翰|12212309|33%|数据导入、用户密码的安全存储、|
|许致韬|12211818|33%|数据导入的脚本优化、报告撰写|
|董炳闻|12211111|33%|数据导入的多线程优化、推荐|
### 一、数据库设计
#### 1.E-R图（实体关系图）
![[ER_diagram.png]]
#### 2.表格可视化
![[数据库可视化.png]]
#### 3.表格设计描述
| 表格名称        | 描述                                                  |
|----------------|-------------------------------------------------------|
| users          | 用于存储用户信息，包括用户的唯一标识号 (mid)，名称，性别，生日，等级，个人描述等。使用**自增主键**来确保数据唯一性。 |
| user_follow    | 存储用户之间的关注关系，包括关注者的用户ID和被关注者的用户ID。同时使用这两个字段作为**复合主键**，防止重复关注关系的插入。 |
| videos         | 用于存储视频信息，包括视频的唯一标识字符串 (bv)，标题，所有者的用户ID，提交时间，公开时间，持续时间等。 |
| review         | 存储视频审核信息，包括视频的唯一标识字符串 (bv)，审核者的用户ID，审核时间等。**复合主键**由 bv 和 reviewer_mid 组成，确保数据的唯一性。 |
| danmu          | 存储视频弹幕信息，包括所属视频的BV，发送者的用户ID，弹幕显示的时间，内容等。使用**自增主键** (id) 来确保每个弹幕的唯一标识。 |
| danmu_likes    | 记录用户对弹幕的点赞信息，包括弹幕的唯一标识符 (id) 和点赞用户的ID。**复合主键**由这两个字段组成，确保了用户对同一弹幕的点赞不重复。 |
| likes          | 存储对视频的点赞信息，包括被点赞视频的BV和点赞用户的ID。使用**复合主键**确保了用户对同一视频的点赞不重复。 |
| coin           | 跟踪用户对视频的硬币打赏情况，包括被打赏视频的BV和打赏用户的mid。**复合主键**确保了用户对同一视频的打赏不重复。 |
| favorite       | 记录用户收藏的视频，包括视频的BV和收藏视频的用户的mid。复**合主键**用于确保用户收藏的视频不重复。 |
| view           | 记录用户观看视频的情况，包括观看的视频的BV，观看视频的用户的mid，以及最后一次观看视频的时间戳。**复合主键**确保用户对同一视频的观看记录不重复。 |
****
#### 4.数据库设计概述
除了表格设计方面的优势外，这个数据库还具有以下其他方面的优势
1. **数据一致性和完整性：** 通过在数据库中使用外键关系和主键约束，确保了数据的一致性和完整性。这防止了不合法的数据插入，同时保证了数据的一致性，减少了数据错误的可能性。
2. **查询性能优化：** 数据表中的自增主键自动创建索引，提高了对表的检索和查询性能。这在大型数据库中尤其重要，可以加速数据检索操作。
3. **用户权限管理：** 使用 GRANT 命令对用户授予不同级别的数据库访问权限，确保了数据的安全性和可访问性。这意味着只有授权的用户可以执行特定的数据库操作，保护了敏感数据免受未经授权的访问。
4. **存储过程支持：** 创建了一个名为 "search_videos" 的存储过程，该存储过程接受关键字、用户ID、分页大小和页数作为参数，并返回相关视频的信息。这有助于实现高级查询功能，提供更灵活和强大的数据检索能力。
5. **强化数据关系：** 数据库中定义了多个表格，用于存储不同实体（用户、视频、弹幕）及其关系。这有助于更好地组织和管理不同类型的数据，并简化了复杂数据关系的处理。
6. **数据的可扩展性：** 数据库设计考虑到了不同实体之间的关系，这使得将来可以轻松扩展数据库以满足新需求。例如，可以添加新的实体或扩展现有实体的属性，而不会破坏数据库的整体结构。
7. **符合三大范式：** 数据库设计符合三大范式，减少了数据冗余，避免了数据异常，并提高了数据的完整性和查询效率。这有助于确保数据的一致性和质量。
### 二、基本API的实现
#### 代码亮点
1. **连接池框架的使用：** 我们充分利用了自带的连接池框架，确保数据库连接的高效重复利用。
2. **可读性和简洁性：** 我们的代码注重可读性和简洁性，充分注释和文档化，使代码易于理解和维护。
3. **BV生成方法的借鉴：** 在生成唯一标识字符串 (BV) 的过程中，我们借鉴了市面上成熟的方法，特别参考了B站的实践，确保了生成的BV的唯一性和规范性。
4. **代码复用：** 我们采用了模块化的编程风格，将相似的功能封装成子方法，以实现代码的复用和可维护性。
5. **用户权限管理：** 我们实现了用户权限管理机制，普通用户默认权限为 "sustc"，在需要超级用户权限时进行切换，确保了系统的安全性和数据保护。
6. **异常处理和资源释放：** 我们使用try-catch模块的自动关闭功能，确保了所有连接、预编译语句和结果集的及时关闭，以提高性能和资源管理效率。
综上，我们的数据库实现不仅追求性能优化和数据安全性，还注重代码的可维护性和可读性，为系统提供了强大的数据库支持。
### 三、高级API
#### **代码亮点**
在我们的数据库设计和实施过程中，我们采用了一系列高级技术和策略来优化性能、增强安全性，并提高系统的稳定性。以下是我们数据库代码中的一些主要亮点：
1. **批处理优化：** 我们利用批处理技术，通过一次性提交多个操作，显著减少了与数据库的交互次数。这一策略不仅提高了数据处理的效率，还降低了数据库的负担，使系统更加高效。
2. **多线程和线程池的使用：** 为了确保系统在高负载情况下的稳定性和响应速度，我们从单线程开始，逐步引入了多线程和线程池。这样，系统能够更好地处理并发请求，提供更快的响应时间。
3. **连接池框架的使用：** 我们采用了连接池来管理数据库连接，从而最大程度地减少了连接的创建和销毁，提高了数据库访问的效率。除了自带的连接池框架，我们还引入了阿里的连接池，去除了连接数量的限制，进一步提升了系统的性能和响应速度。
4. **密码安全性：** 为了保护用户数据的安全性，我们考虑了不同的密码存储选项。虽然加盐的哈希算法如 PBKDF2提供了更高的安全性，但由于时间成本较高，我们选择存储经过SHA256哈希算法加密后的密码，而不是直接存储原始密码。这种做法有效地提高了用户数据的安全性，同时保持了较低的响应时间。
5. **SQL优化策略：** 我们在数据库查询中采用了一系列SQL优化策略，包括建立索引、精确字段选择、避免使用IN和NOT IN、使用UNION代替OR、避免模糊查询、避免null值判断等。这些策略旨在提高查询性能、减少数据库负担，使系统更加高效和稳定。
通过这些代码亮点，我们的数据库系统不仅能够高效地处理数据，还能够保护用户的隐私和数据安全，为用户提供出色的体验。